<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>ASU Library</title>
	<!--DO NOT FORGET THIS SCRIPT TAG SO YOU CAN USE JQUERY!!!!!-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="ASUstyle.css">

	<!--YOUR OWN JAVASCRIPT CAN GO RIGHT HERE-->
	<script type="text/javascript"> 
        var books;
        var activeID;
		
        function LoadBooks() {
            var webMethod = "ProjectServices.asmx/LoadBooks";
            var parameters = "{}";

            //jQuery ajax method
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (array) {
                    books = array.d;
                    var stmt = '';
                    for (var i = 0; i < books.length; i++) {
                        stmt = stmt + "<input type='radio' name='book' value='" + books[i].isbn + "'>" + "<label for='" + books[i].isbn + "'>" +
                            books[i].title + " by " + books[i].author + " -- Remaining:  " + books[i].quantity + "<label><br>";
                    }
                    document.getElementById("booklist").innerHTML = stmt;
                },
                error: function (e) {
                    alert("error");
                }
            });
        } 

        function CheckoutBook() {
        var title, isbn, days;
        var radios = document.getElementsByName('book');
        var id = activeID; //use global ID from session

        for (var i = 0, length = radios.length; i < length; i++) {
            if (radios[i].checked) {
                var quan = books[i].quantity;
                if (quan < 1) {
                    return alert("No books left!");
                    break;
                }
                /*else if (id = null) {
                    return alert("Not logged in!")
                    break;
                }*/
                else {
                    isbn = radios[i].value;
                    title = books[i].title;
                    days = books[i].rentalDays;
                }

                // only one radio can be logically checked, don't check the rest
                break;
            }
        }
           

            var webMethod = "ProjectServices.asmx/CheckoutBook";
            var parameters = "{\"ID\":\"" + encodeURI(id) + "\", \"ISBN\":\"" +
                             encodeURI(isbn) + "\", \"daysOut\":\"" + encodeURI(days) + "\"}";

            //jQuery ajax method
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function () {
                    alert("Sucessfully checked out book: " + title);
                    location.reload();
                    }
                ,
                error: function (e) {
                    alert("error");
                }
            });
        } 

        function LogOn(userId, pass) {
            //the url of the webservice we will be talking to
            var webMethod = "ProjectServices.asmx/LogOn";
            //the parameters we will pass the service (in json format because curly braces)
            //note we encode the values for transmission over the web.  All the \'s are just
            //because we want to wrap our keynames and values in double quotes so we have to
            //escape the double quotes (because the overall string we're creating is in double quotes!)
            var parameters = "{\"uid\":\"" + encodeURI(userId) + "\",\"pass\":\"" + encodeURI(pass) + "\"}";

            //jQuery ajax method
            $.ajax({
                //post is more secure than get, and allows
                //us to send big data if we want.  really just
                //depends on the way the service you're talking to is set up, though
                type: "POST",
                //the url is set to the string we created above
                url: webMethod,
                //same with the data
                data: parameters,
                //these next two key/value pairs say we intend to talk in JSON format
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                //jQuery sends the data and asynchronously waits for a response.  when it
                //gets a response, it calls the function mapped to the success key here
                success: function (id) {
                    if (id.d) {
                        //server replied true
                        activeID = id.d;
                        alert("Logged in!");
                        LoadUser();
                        LoadBooks();

                    }
                    else {
                        //server replied false, so let the user know
                        //the logon failed
                        alert("logon failed");
                    }
                },
                error: function (e) {
                    //if something goes wrong in the mechanics of delivering the
                    //message to the server or the server processing that message,
                    //then this function mapped to the error key is executed rather
                    //than the one mapped to the success key.  This is just a garbage
                    //alert because I'm lazy
                    alert("boo...");
                }
            });
        }

        function LoadUser() {
            var id = activeID;
            var webMethod = "ProjectServices.asmx/LoadUser";
            var parameters = "{\"ID\":\"" + encodeURI(id) + "\"}";

            //jQuery ajax method
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (user) {
                    var activeUser = user.d;
                    alert("Welcome, " + activeUser.name);
                    var stmt = "<h1>Your Books</h1><table id = 'booktable'><tr> <th> Book</th> <th>Return Date</th>"
                    for (var i = 0; i < activeUser.books.length; i++) {
                        stmt = stmt + "<tr><td>" + activeUser.books[i].title +
                            "</td><td>" + activeUser.books[i].returndate.slice(0, 8) + "</td></tr>"
                    }
                    stmt = stmt + "</table>";
                    document.getElementById("rentedbooks").innerHTML = stmt;

                },
                error: function (e) {
                    alert("error");
                }
            });
        }


	</script>
	<!--END OF YOUR OWN JAVASCRIPT-->
</head >
<body>
    <div><h1 id="titleID">ASU Library</h1></div>
    <div class="topnav">
        <a class="active" href="#home">Home</a>
        <a href="user.html">User Page</a>
        <a href="#contact">Contact</a>
        <input type="text" placeholder="Search..">
    </div>
    <div id="booksID">
        <ul id="booklist"></ul>
    </div>
    <div class="container">
        <label for="uname"><b>Username</b></label>
        <input type="text" placeholder="Enter Username" id="uname" required>

        <label for="psw"><b>Password</b></label>
        <input type="password" placeholder="Enter Password" id="psw" required>

        <button type="submit" onclick="LogOn(getElementById('uname').value, getElementById('psw').value)">Login</button>
        <div id="rentedbooks">

        </div>

        <div id="buttonsID">
            <button class="buttons">Check In</button>
            <button class="buttons" onclick="CheckoutBook()">Check Out</button>
        </div>
        </div>

</body>
</html >
